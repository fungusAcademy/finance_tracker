{% extends 'base.html' %}

{% block content %}
<div class="container">
    <h1>üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤</h1>
    
    <!-- Total Balance -->
    <div class="stats-grid">
        <div class="stat-card" style="background: #e7f6e7;">
            <h3>üí∞ –û–±—â–∏–π –±–∞–ª–∞–Ω—Å</h3>
            <p class="amount {% if balance >= 0 %}positive{% else %}negative{% endif %}">
                {{ balance }} —Ä—É–±.
            </p>
        </div>
        <div class="stat-card" style="background: #e7f3ff;">
            <h3>üìà –î–æ—Ö–æ–¥—ã</h3>
            <p class="amount positive">{{ income_total }} —Ä—É–±.</p>
        </div>
        <div class="stat-card" style="background: #ffe7e7;">
            <h3>üìâ –†–∞—Å—Ö–æ–¥—ã</h3>
            <p class="amount negative">{{ expense_total }} —Ä—É–±.</p>
        </div>
    </div>

    <!-- Expences chart by categories -->
    <div class="chart-section">
        <h3>üìã –†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º (–∑–∞ 30 –¥–Ω–µ–π)</h3>
        <canvas id="categoryChart" width="400" height="200"></canvas>
    </div>

    <!-- Budget comparison -->
    <div class="budget-section">
        <h3>üéØ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –±—é–¥–∂–µ—Ç–æ–º</h3>
        <div id="budgetChart"></div>
        
        <table class="budget-table">
            <tr>
                <th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th>
                <th>–ë—é–¥–∂–µ—Ç</th>
                <th>–ü–æ—Ç—Ä–∞—á–µ–Ω–æ</th>
                <th>–û—Å—Ç–∞—Ç–æ–∫</th>
            </tr>
            {% for item in budget_comparison %}
            <tr>
                <td>{{ item.category }}</td>
                <td>{{ item.budget_amount }} —Ä—É–±.</td>
                <td>{{ item.actual_spent }} —Ä—É–±.</td>
                <td class="{% if item.remaining >= 0 %}positive{% else %}negative{% endif %}">
                    {{ item.remaining }} —Ä—É–±.
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="4">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –±—é–¥–∂–µ—Ç–æ–≤</td>
            </tr>
            {% endfor %}
        </table>
    </div>
</div>

<!-- Connecting Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.stat-card {
    padding: 20px;
    border-radius: 8px;
    text-align: center;
}

.amount {
    font-size: 1.5em;
    font-weight: bold;
    margin: 10px 0 0 0;
}

.positive { color: #28a745; }
.negative { color: #dc3545; }

.chart-section, .budget-section {
    margin: 40px 0;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 8px;
}

.budget-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
}

.budget-table th, .budget-table td {
    padding: 10px;
    border: 1px solid #ddd;
    text-align: left;
}

.budget-table th {
    background: #007bff;
    color: white;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // pass data from django to JS through date-attributes
    const categoryStats = JSON.parse('{{ category_stats_json|escapejs }}');
    const budgetComparison = JSON.parse('{{ budget_comparison_json|escapejs }}');

    const categoryData = {
        labels: categoryStats.map(stat => stat.category__name || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'),
        datasets: [{
            label: '–†–∞—Å—Ö–æ–¥—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º',
            data: categoryStats.map(stat => stat.total),
            backgroundColor: [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
                '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
            ]
        }]
    };

    // Create diagram
    if (categoryStats.length > 0) {
        const categoryChart = new Chart(document.getElementById('categoryChart'), {
            type: 'pie',
            data: categoryData,
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom',
                    }
                }
            }
        });
    }

    // Budget graph
    if (budgetComparison.length > 0) {
        const budgetData = {
            labels: budgetComparison.map(item => item.category),
            datasets: [
                {
                    label: '–ë—é–¥–∂–µ—Ç',
                    data: budgetComparison.map(item => item.budget_amount),
                    backgroundColor: '#36A2EB'
                },
                {
                    label: '–ü–æ—Ç—Ä–∞—á–µ–Ω–æ',
                    data: budgetComparison.map(item => item.actual_spent),
                    backgroundColor: '#FF6384'
                }
            ]
        };

        // Create canvas for budget graph
        const budgetCanvas = document.createElement('canvas');
        budgetCanvas.width = 400;
        budgetCanvas.height = 200;
        document.getElementById('budgetChart').appendChild(budgetCanvas);

        new Chart(budgetCanvas, {
            type: 'bar',
            data: budgetData,
            options: {
                responsive: true,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
});
</script>

{% endblock %}